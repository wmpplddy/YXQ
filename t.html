<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¶å­å·æ‡’å·¥å…·</title>
    <style>
      body {
        font-family: "Segoe UI", "PingFang SC", Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: linear-gradient(135deg, #f7b42c 0%, #fc575e 100%);
        color: #222;
        min-height: 100vh;
      }
      .pw-container {
        max-width: 340px;
        margin: 12vh auto 0 auto;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.1);
        padding: 2.5rem 2rem 2rem 2rem;
        text-align: center;
        animation: float 2s infinite alternate;
      }
      @keyframes float {
        from {
          transform: translateY(0);
        }
        to {
          transform: translateY(-10px);
        }
      }
      .pw-emoji {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
        display: block;
      }
      .pw-title {
        font-size: 1.5rem;
        margin-bottom: 1.2rem;
        color: #fc575e;
        letter-spacing: 2px;
      }
      .pw-input {
        width: 100%;
        font-size: 1.1rem;
        padding: 0.7rem;
        margin-bottom: 1rem;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-sizing: border-box;
      }
      .pw-btn {
        width: 100%;
        background: #fc575e;
        color: #fff;
        border: none;
        cursor: pointer;
        font-weight: bold;
        font-size: 1.1rem;
        border-radius: 8px;
        padding: 0.7rem 0;
        transition: background 0.2s;
      }
      .pw-btn:hover {
        background: #f7b42c;
      }
      #pwmsg {
        color: #fc575e;
        margin-top: 0.5rem;
        min-height: 1.2em;
      }
      @media (max-width: 500px) {
        .pw-container {
          padding: 1.5rem 0.5rem 1rem 0.5rem;
          max-width: 95vw;
        }
        .pw-title {
          font-size: 1.1rem;
        }
        .pw-emoji {
          font-size: 2rem;
        }
      }
      .container {
        max-width: 520px;
        margin: 2rem auto;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        padding: 1.5rem;
      }
      h2 {
        text-align: center;
        margin-bottom: 1.2rem;
      }
      label {
        display: block;
        margin: 0.8rem 0 0.3rem 0;
        font-weight: 500;
      }
      input,
      textarea,
      button {
        width: 100%;
        font-size: 1rem;
        padding: 0.6rem;
        margin-bottom: 1rem;
        border: 1px solid #ddd;
        border-radius: 6px;
        box-sizing: border-box;
      }
      textarea {
        resize: vertical;
        min-height: 100px;
        max-height: 300px;
      }
      button {
        background: #0078ff;
        color: #fff;
        border: none;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.2s;
      }
      button:hover {
        background: #005fcc;
      }
      .result {
        background: #f0f4fa;
        border-radius: 6px;
        padding: 1rem;
        min-height: 2rem;
        word-break: break-all;
        white-space: pre-wrap;
        margin-top: 2.5rem;
      }
      .copy-btn {
        width: auto;
        margin-bottom: 0.5rem;
        float: right;
        background: #4caf50;
      }
      @media (max-width: 600px) {
        .container {
          margin: 0;
          border-radius: 0;
          box-shadow: none;
          padding: 1rem;
        }
      }
      .toast {
        position: fixed;
        left: 50%;
        top: 10%;
        transform: translateX(-50%);
        background: linear-gradient(90deg, #fc575e 0%, #f7b42c 100%);
        color: #fff;
        padding: 1rem 2.2rem;
        border-radius: 2rem;
        font-size: 1.1rem;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.12);
        z-index: 9999;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
      }
      .toast.show {
        opacity: 1;
        pointer-events: auto;
      }
    </style>
  </head>
  <body>
    <div id="lock" class="pw-container">
      <span class="pw-emoji">ğŸ”’</span>
      <div class="pw-title">è¾“å…¥å£ä»¤~</div>
      <input
        id="pw"
        class="pw-input"
        type="password"
        placeholder="è¯·è¾“å…¥ä¸“å±å£ä»¤"
      />
      <button class="pw-btn" onclick="checkPW()">è¿›å…¥</button>
      <div id="pwmsg"></div>
    </div>
    <div id="mainContent" style="display: none">
      <div class="container">
        <h2>å°å¶å­ä¹‹å·æ‡’å·¥å…·ç¯‡</h2>
        <label for="rawInput">1. ç²˜è´´æ˜¨æ—¥æ—¥æŠ¥åŸæ–‡ï¼š</label>
        <textarea
          id="rawInput"
          oninput="saveRawInput()"
          placeholder="è¯·ç²˜è´´æ˜¨æ—¥çš„ç»è¥æ—¥æŠ¥åŸæ–‡"
        ></textarea>
        <label for="actualInput">2. è¾“å…¥ä»Šæ—¥å®é™…é‡‘é¢ï¼š</label>
        <input
          id="actualInput"
          type="number"
          step="0.01"
          oninput="syncActualToStorage()"
          placeholder="å¦‚ï¼š12345.67"
        />
        <label for="tasteInput">3. è¾“å…¥ä»Šæ—¥è¯•åƒé‡‘é¢ï¼š</label>
        <input
          id="tasteInput"
          type="number"
          step="0.01"
          placeholder="å¦‚ï¼š200"
        />
        <label for="lossInput">4. è¾“å…¥ä»Šæ—¥æŠ¥æŸé‡‘é¢ï¼š</label>
        <input id="lossInput" type="number" step="0.01" placeholder="å¦‚ï¼š150" />
        <button onclick="parseReport()">ç”Ÿæˆä»Šæ—¥æ—¥æŠ¥</button>
        <button
          onclick="clearAllStorage()"
        >
          ä¸€é”®æ¸…é™¤æ‰€æœ‰æ•°æ®
        </button>
        <button class="copy-btn" onclick="copyResult()">å¤åˆ¶ç»“æœ</button>
        <button
          class="copy-btn"
          style="background: #ff9800; margin-left: 8px"
          onclick="window.location.href='1.html'"
        >
          å»å›¾ç‰‡è®¡ç®—
        </button>
        <div></div>
        <div id="imgCalcResultBox" style="margin-top: 10px; display: none">
          <div style="font-weight: bold; margin-bottom: 0.5rem">
            å›¾ç‰‡è®¡ç®—ç»“æœ
          </div>
          <div
            id="imgCalcResultList"
            style="
              background: #f0f4fa;
              border-radius: 6px;
              padding: 0;
              margin-top: 15px;
              word-break: break-all;
              white-space: normal;
              margin-left: auto;
              margin-right: auto;
              width: 100%;
              box-sizing: border-box;
            "
          ></div>
        </div>
        <div class="result" id="result" contenteditable="true"></div>
        <div style="margin-top: 1.5rem; color: #888; font-size: 0.95rem">
          <b>ä½¿ç”¨è¯´æ˜ï¼š</b><br />
          1. ç²˜è´´æ˜¨æ—¥æ—¥æŠ¥åŸæ–‡<br />
          2. è¾“å…¥ä»Šæ—¥å®é™…ã€è¯•åƒã€æŠ¥æŸé‡‘é¢<br />
          3. ç‚¹å‡»"ç”Ÿæˆä»Šæ—¥æ—¥æŠ¥"è‡ªåŠ¨æ›¿æ¢å¹¶è®¡ç®—<br />
          4. å¯ä¸€é”®å¤åˆ¶ç»“æœ
        </div>
      </div>
    </div>
    <div class="toast" id="toast"></div>
    <script>
      function clearAllStorage() {
        localStorage.clear();
        showToast(
          "å·²æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®ï¼Œé¡µé¢å°†åˆ·æ–°",
          "linear-gradient(90deg, #fc575e 0%, #f7b42c 100%)"
        );
        setTimeout(() => {
          location.reload();
        }, 1200);
      }
      function saveRawInput() {
        const val = document.getElementById("rawInput").value;
        localStorage.setItem("raw_daily_report", val);
      }
      document.getElementById("rawInput").addEventListener("paste", saveRawInput);
      window.onload = function () {
        // 30åˆ†é’Ÿ = 1800000 æ¯«ç§’
        const verified = localStorage.getItem("pw_verified");
        const time = parseInt(localStorage.getItem("pw_verified_time"), 10);
        const savedReport = localStorage.getItem("daily_report_result");
        const savedRaw = localStorage.getItem("raw_daily_report");
        if (savedRaw !== null) {
          document.getElementById("rawInput").value = savedRaw;
        }
        if (savedReport) {
          document.getElementById("result").textContent = savedReport;
        }
        if (verified === "true" && time && Date.now() - time < 1800000) {
          document.getElementById("lock").style.display = "none";
          document.getElementById("mainContent").style.display = "";
          const todayActual = localStorage.getItem("today_actual") || "";
          document.getElementById("actualInput").value = todayActual;
        } else {
          // è¿‡æœŸæˆ–æœªéªŒè¯ï¼Œæ¸…é™¤æ ‡è®°
          localStorage.removeItem("pw_verified");
          localStorage.removeItem("pw_verified_time");
        }
      };
      function syncActualToStorage() {
        const val = document.getElementById("actualInput").value;
        localStorage.setItem("today_actual", val);
      }
      function renderImgCalcResult() {
        const box = document.getElementById("imgCalcResultBox");
        const list = document.getElementById("imgCalcResultList");
        const data = JSON.parse(
          localStorage.getItem("img_calc_result") || "[]"
        );
        if (data.length === 0) {
          box.style.display = "none";
          return;
        }
        box.style.display = "";
        let html = "";
        data.forEach((item) => {
          const displayLine = `${item.name} ${item.sum} å æ¯”${item.percent}%`;
          const copyLine = `${item.sum} å æ¯”${item.percent}%`;
          html += `
  <div style="display:flex;align-items:center;justify-content:space-between;padding:0 4px 0 4px;box-sizing:border-box;width:100%;">
    <span style="font-size:0.98em;color:#222;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1 1 auto;">${displayLine}</span>
    <button class="copy-btn" style="background:#222;color:#fff;padding:2px 10px;font-size:0.92em;line-height:1.1;height:1.7em;min-width:2.5em;flex-shrink:0;" 
    onclick="replaceProductInResult('${item.name}', '${item.sum} å æ¯”${item.percent}%')">æ›¿æ¢</button>
  </div>
`;
        });
        list.innerHTML = html;
        // ä¹Ÿå¯ä»¥ç”¨ innerHTML å’Œ <br>ï¼Œä½† textContent æ›´é€‚åˆå¤åˆ¶
      }

      function replaceProductInResult(productName, newValue) {
        const resultDiv = document.getElementById("result");
        let text = resultDiv.textContent;

        // åŒ¹é…â€œäº§å“åé”€å”®ç›®æ ‡xx%ï¼Œè¾¾æˆé¢: å æ¯”%â€æˆ–â€œäº§å“åé”€å”®ç›®æ ‡xx%ï¼Œè¾¾æˆé¢ï¼šå æ¯”%â€
        // å…è®¸â€œè¾¾æˆé¢:â€å’Œâ€œè¾¾æˆé¢ï¼šâ€ï¼Œå…è®¸â€œå æ¯”%â€åé¢æœ‰å†…å®¹
        const reg = new RegExp(
          "(\\d+[\\.ã€ï¼]\\s*)?" +
            productName +
            "\\s*é”€å”®ç›®æ ‡[^\\d\\n]*[\\d.]+%[ï¼Œ,ã€:ï¼š ]*è¾¾æˆé¢\\s*[:ï¼š][^\\n]*",
          "g"
        );

        let replaced = false;
        let replacedLine = "";

        text = text.replace(reg, (match) => {
          const prefix = match.replace(/(è¾¾æˆé¢[:ï¼š]).*$/, "$1");
          replaced = true;
          replacedLine = prefix + newValue;
          return replacedLine;
        });

        resultDiv.textContent = text;
        localStorage.setItem("daily_report_result", text);

        // æ›¿æ¢æˆåŠŸæ—¶æç¤º
        if (replaced) {
          showToast(
            "å·²æ›¿æ¢ï¼š" + replacedLine,
            "linear-gradient(90deg, #4caf50 0%, #43e97b 100%)"
          );
        } else {
          showToast(
            "æœªæ‰¾åˆ°åŒ¹é…å†…å®¹",
            "linear-gradient(90deg, #fc575e 0%, #f7b42c 100%)"
          );
        }
      }

      // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ¸²æŸ“
      window.addEventListener("DOMContentLoaded", renderImgCalcResult);

      // æ˜¾ç¤ºtoast
      function showToast(msg, color) {
        const toast = document.getElementById("toast");
        toast.textContent = msg;
        toast.style.background =
          color || "linear-gradient(90deg, #fc575e 0%, #f7b42c 100%)";
        toast.classList.add("show");
        setTimeout(() => {
          toast.classList.remove("show");
        }, 1800);
      }
      const hash = "cXh5";
      function checkPW() {
        const val = document.getElementById("pw").value;
        const encoded = btoa(val.split("").reverse().join(""));
        if (encoded === hash) {
          localStorage.setItem("pw_verified", "true");
          localStorage.setItem("pw_verified_time", Date.now().toString());
          document.getElementById("lock").style.display = "none";
          document.getElementById("mainContent").style.display = "";
        } else {
          showToast(
            "å£ä»¤é”™è¯¯ï¼Œè¯·é‡è¯•~",
            "linear-gradient(90deg, #fc575e 0%, #f7b42c 100%)"
          );
          document.getElementById("pwmsg").innerText = "";
        }
      }
      function parseNumber(str) {
        if (!str) return 0;
        return parseFloat((str + "").replace(/[^\d.\-]/g, "")) || 0;
      }
      function percent(val, total) {
        if (!total) return "0%";
        return ((val / total) * 100).toFixed(2) + "%";
      }
      function parseReport() {
        const raw = document.getElementById("rawInput").value;
        const todayActual = parseNumber(
          document.getElementById("actualInput").value
        );
        const todayTaste = parseNumber(
          document.getElementById("tasteInput").value
        );
        const todayLoss = parseNumber(
          document.getElementById("lossInput").value
        );
        if (!raw.trim() || !todayActual) {
          showToast(
            "è¯·ç²˜è´´æ—¥æŠ¥åŸæ–‡å¹¶è¾“å…¥ä»Šæ—¥å®é™…é‡‘é¢",
            "linear-gradient(90deg, #fc575e 0%, #f7b42c 100%)"
          );
          return;
        }
        // è§£ææ˜¨æ—¥æ•°æ®
        // ä»Šæ—¥ç›®æ ‡
        const targetMatch = raw.match(/ä»Šæ—¥ç›®æ ‡[:ï¼š]\s*([\d.]+)/);
        const todayTarget = targetMatch ? parseNumber(targetMatch[1]) : 0;
        // æ˜¨æ—¥å®é™…
        const actualMatch = raw.match(/ä»Šæ—¥å®é™…[:ï¼š]\s*([\d.]+)/);
        // æœ¬æœˆæŒ‡æ ‡
        const monthTargetMatch = raw.match(/æœ¬æœˆæŒ‡æ ‡[:ï¼š]\s*([\d.]+)/);
        const monthTarget = monthTargetMatch
          ? parseNumber(monthTargetMatch[1])
          : 0;
        // æœ¬æœˆè¾¾æˆ
        const monthDoneMatch = raw.match(/æœ¬æœˆè¾¾æˆ[:ï¼š]\s*([\d.]+)/);
        const monthDone = monthDoneMatch ? parseNumber(monthDoneMatch[1]) : 0;
        // è¯•åƒ
        const tasteMatch = raw.match(/è¯•åƒ[:ï¼š]\s*([\d.]+)/);
        // æŠ¥æŸ
        const lossMatch = raw.match(/æŠ¥æŸ[:ï¼š]\s*([\d.]+)/);
        // æŠ¥æŸæœ€é«˜äº§å“
        const lossProductMatch = raw.match(/æŠ¥æŸæœ€é«˜äº§å“\+é‡‘é¢[:ï¼š]?([^\n]+)/);
        const lossProduct = lossProductMatch ? lossProductMatch[1].trim() : "";

        let result = raw;
        // ä»Šæ—¥å®é™…
        result = result.replace(
          /(ä»Šæ—¥å®é™…[:ï¼š])([\d.]+)(ï¼ˆ[\d.%]+ï¼‰)?/,
          `$1${todayActual}ï¼ˆ${percent(todayActual, todayTarget)}ï¼‰`
        );
        // æœ¬æœˆè¾¾æˆï¼ˆå…¨å±€æ›¿æ¢ï¼‰
        const newMonthDone = monthDone + todayActual;
        result = result.replace(
          /([\S\s]{0,2}æœ¬æœˆè¾¾æˆ[:ï¼š]\s*)([\d.]+)(ï¼ˆ[\d.%]+ï¼‰)?/g,
          `$1${newMonthDone}ï¼ˆ${percent(newMonthDone, monthTarget)}ï¼‰`
        );
        // è¯•åƒ
        result = result.replace(
          /(è¯•åƒ[:ï¼š])([\d.]+)(ï¼ˆ[\d.%]+ï¼‰)?/,
          `$1${todayTaste}ï¼ˆ${percent(todayTaste, todayActual)}ï¼‰`
        );
        // æŠ¥æŸ
        result = result.replace(
          /(æŠ¥æŸ[:ï¼š])([\d.]+)([ï¼ˆ(][\d.%]+[ï¼‰)])?/,
          `$1${todayLoss}ï¼ˆ${percent(todayLoss, todayActual)}ï¼‰`
        );
        localStorage.setItem("daily_report_result", result);

        document.getElementById("result").textContent = result;
      }
      function copyResult() {
        const result = document.getElementById("result").innerText;
        if (!result) return;
        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard
            .writeText(result)
            .then(() => {
              showToast(
                "å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼",
                "linear-gradient(90deg, #4caf50 0%, #43e97b 100%)"
              );
            })
            .catch(() => {
              fallbackCopy(result);
            });
        } else {
          fallbackCopy(result);
        }
        function fallbackCopy(text) {
          const textarea = document.createElement("textarea");
          textarea.value = text;
          textarea.setAttribute("readonly", "");
          textarea.style.position = "absolute";
          textarea.style.left = "-9999px";
          document.body.appendChild(textarea);
          textarea.select();
          try {
            const successful = document.execCommand("copy");
            if (successful) {
              showToast(
                "å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼",
                "linear-gradient(90deg, #4caf50 0%, #43e97b 100%)"
              );
            } else {
              showToast(
                "å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é•¿æŒ‰ç»“æœåŒºåŸŸå¤åˆ¶",
                "linear-gradient(90deg, #fc575e 0%, #f7b42c 100%)"
              );
            }
          } catch (err) {
            showToast(
              "å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é•¿æŒ‰ç»“æœåŒºåŸŸå¤åˆ¶",
              "linear-gradient(90deg, #fc575e 0%, #f7b42c 100%)"
            );
          }
          document.body.removeChild(textarea);
        }
      }
    </script>
  </body>
</html>
